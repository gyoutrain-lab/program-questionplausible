from gpt4all import GPT4All
import csv
import random
import json

# Initialize GPT4All local model
model = GPT4All("ggml-gpt4all-j-v1.3-groovy")  # adjust filename

def generate_smart_options(question, language="id"):
    """
    Generate 4 scientifically credible options for any question,
    analyze keywords, maintain proportional narration,
    assign plausibility, and provide rationale for correct answer.
    """
    prompt = f"""
You are an expert in clinical/scientific reasoning. Analyze the following question in {language} and generate 4 answer options:
- Detect keywords and context automatically to produce scientifically credible answers.
- One option must be the "Most plausible" (correct answer).
- Other 3 options should be plausible but less ideal, with proportional descriptive narration.
- Each option must include a plausibility tag: Most plausible, Plausible, Less plausible, Not plausible.
- Provide a detailed rationale only for the most plausible option.
- Return output in valid JSON like:
{{
"options": ["Option1","Option2","Option3","Option4"],
"plausibility": ["Most plausible","Plausible","Less plausible","Not plausible"],
"correct_index": 0,
"rationale": "Detailed rationale for the most plausible option"
}}
Question: "{question}"
"""
    response = model.generate(prompt)
    try:
        data = json.loads(response.strip())
        return data
    except:
        print(f"[WARNING] Could not parse output. Using fallback for: {question}")
        options = [
            f"{question} - Correct action",
            f"{question} - Plausible alternative",
            f"{question} - Less ideal option",
            f"{question} - Not plausible option"
        ]
        plausibility = ["Most plausible","Plausible","Less plausible","Not plausible"]
        random.shuffle(options)
        return {
            "options": options,
            "plausibility": plausibility,
            "correct_index": 0,
            "rationale": f"Rationale for correct option: {question}"
        }

def generate_quiz_intelligent(questions, language="id"):
    quiz = []
    for idx, q in enumerate(questions, start=1):
        data = generate_smart_options(q, language)
        options = data["options"]
        plausibility = data["plausibility"]

        # Shuffle options and track correct answer
        indices = [0,1,2,3]
        random.shuffle(indices)
        shuffled_options = [options[i] for i in indices]
        shuffled_plausibility = [plausibility[i] for i in indices]
        correct_letter = chr(65 + indices.index(data["correct_index"]))

        quiz.append({
            "No": idx,
            "Questions": q,
            "OptionA": shuffled_options[0],
            "OptionB": shuffled_options[1],
            "OptionC": shuffled_options[2],
            "OptionD": shuffled_options[3],
            "CorrectAnswer": correct_letter,
            "Rationale": data["rationale"],
            "PlausibilityA": shuffled_plausibility[0],
            "PlausibilityB": shuffled_plausibility[1],
            "PlausibilityC": shuffled_plausibility[2],
            "PlausibilityD": shuffled_plausibility[3]
        })
    return quiz

def save_quiz_csv(quiz, filename="quiz_generated.csv"):
    headers = ["No","Questions","OptionA","OptionB","OptionC","OptionD",
               "CorrectAnswer","Rationale","PlausibilityA","PlausibilityB",
               "PlausibilityC","PlausibilityD"]
    with open(filename, "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=headers)
        writer.writeheader()
        for row in quiz:
            writer.writerow(row)
    print(f"[INFO] Quiz saved to {filename}")

if __name__ == "__main__":
    filename = input("Enter filename containing questions (one per line): ").strip()
    language = input("Enter language ('id' or 'en'): ").strip().lower()
    try:
        with open(filename, "r", encoding="utf-8") as f:
            questions = [line.strip() for line in f if line.strip()]
        quiz = generate_quiz_intelligent(questions, language)
        save_quiz_csv(quiz)
        print("[INFO] Intelligent quiz generation completed!")
    except FileNotFoundError:
        print(f"[ERROR] File not found: {filename}")
