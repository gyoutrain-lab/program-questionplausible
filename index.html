import csv
import random

# === Example knowledge base / logic ===
# For offline local generation, you can expand this dictionary with more patterns
knowledge_base = {
    "Pasien skizofrenia agresif": {
        "correct": "Amankan lingkungan, observasi perilaku, komunikasi tenang",
        "rationale": "Keselamatan pasien & staf utama; intervensi awal adalah mengamankan lingkungan dan menggunakan komunikasi tenang untuk mencegah eskalasi agresi.",
        "alternatives": [
            "Tegur pasien dengan suara keras",
            "Abaikan pasien",
            "Catat gejala pasien saja"
        ]
    },
    "Anak demam tinggi, kejang": {
        "correct": "Penanganan kejang dan stabilisasi ABC",
        "rationale": "Penanganan darurat kejang prioritas; stabilisasi ABC vital untuk keselamatan pasien.",
        "alternatives": [
            "Berikan obat demam saja",
            "Tunggu demam turun",
            "Catat suhu dan observasi"
        ]
    }
}

def generate_quiz(questions):
    quiz = []
    for idx, q in enumerate(questions, start=1):
        key = q.strip()
        if key not in knowledge_base:
            print(f"[WARNING] Question not found in knowledge base: {q}")
            continue

        data = knowledge_base[key]
        options = [data["correct"]] + data["alternatives"]
        # Randomize options
        random.shuffle(options)
        correct_index = options.index(data["correct"])
        correct_letter = chr(65 + correct_index)  # A-D

        quiz.append({
            "No": idx,
            "Questions": q,
            "OptionA": options[0],
            "OptionB": options[1],
            "OptionC": options[2],
            "OptionD": options[3],
            "CorrectAnswer": correct_letter,
            "Rationale": data["rationale"]
        })
    return quiz

def save_to_csv(quiz, filename="quiz_generated.csv"):
    headers = ["No","Questions","OptionA","OptionB","OptionC","OptionD","CorrectAnswer","Rationale"]
    with open(filename, "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=headers)
        writer.writeheader()
        for row in quiz:
            writer.writerow(row)
    print(f"[INFO] Quiz saved to {filename}")

if __name__ == "__main__":
    # === Input questions ===
    print("Enter your questions (empty line to finish):")
    questions = []
    while True:
        q = input("> ")
        if q.strip() == "":
            break
        questions.append(q.strip())

    quiz = generate_quiz(questions)
    if quiz:
        save_to_csv(quiz)
        print("[INFO] Quiz generation completed!")
    else:
        print("[INFO] No quiz generated. Check your questions and knowledge base.")
