<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student-Specific Quiz Generator</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1 { text-align: center; }
  .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  textarea, input, button { width: 100%; padding: 10px; margin: 5px 0 15px; border-radius: 5px; border: 1px solid #ccc; }
  button { background: #007bff; color: #fff; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>
<div class="container">
<h1>Student-Specific Quiz Generator</h1>

<label>OpenAI API Key:</label>
<input type="password" id="apikey" placeholder="Enter your OpenAI API key">

<label>Questions JSON:</label>
<textarea id="questionsJSON" placeholder='Example: [{"question":"Q1","options":["A","B"],"evidence":["fact1"]}]' rows="8"></textarea>

<label>Student Names (comma-separated):</label>
<textarea id="students" placeholder="Alice,Bob,Charlie" rows="2"></textarea>

<button onclick="generateStudentQuizzes()">Generate Student Quizzes</button>

<div id="results"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
function shuffleArray(array) {
    return array.sort(() => Math.random() - 0.5);
}

async function generateStudentQuizzes() {
    const apiKey = document.getElementById('apikey').value.trim();
    if(!apiKey){ alert("Enter API key"); return; }

    let questions;
    try {
        questions = JSON.parse(document.getElementById('questionsJSON').value);
        if(!Array.isArray(questions)) throw "Invalid format";
    } catch(e){ alert("Invalid JSON input."); return; }

    const studentNames = document.getElementById('students').value.split(',').map(s=>s.trim()).filter(s=>s);
    if(studentNames.length === 0){ alert("Enter at least one student"); return; }

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = 'Generating student quizzes...';

    // AI evaluates questions
    const batchPrompt = `
You are an expert evaluator. For each question below, evaluate the options:
- Assign plausibility (Most plausible, Plausible, Less plausible, Not plausible)
- Identify the correct option
- Provide concise rationale
Return JSON: [{question:"", option:"", plausibility:"", rationale:"", correct:true/false}, ...] without extra text.

Questions: ${JSON.stringify(questions)}
`;

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4",
                messages: [{ role: "user", content: batchPrompt }],
                temperature: 0
            })
        });

        const data = await response.json();
        let text = data.choices[0].message.content.trim();
        let parsed;
        try { parsed = JSON.parse(text); } catch(e){ parsed = []; alert("Error parsing AI output"); return; }

        // Group by question
        const grouped = {};
        parsed.forEach(item=>{
            if(!grouped[item.question]) grouped[item.question] = [];
            grouped[item.question].push(item);
        });

        const { jsPDF } = window.jspdf;

        for(const student of studentNames){
            const doc = new jsPDF();
            let y = 10;
            let qNum = 1;
            doc.setFontSize(12);
            doc.text(`Quiz for ${student}`, 10, y); y+=10;

            const answerKey = [];

            for(let q in grouped){
                doc.setFontSize(12);
                doc.setTextColor("#000000");
                doc.text(`${qNum}. ${q}`, 10, y); y+=7;

                // Shuffle options per student
                let optionsShuffled = shuffleArray(grouped[q]);
                optionsShuffled.forEach((opt,i)=>{
                    let letter = String.fromCharCode(65+i);
                    let color="#000000";
                    if(opt.plausibility.includes("Most")) color="#006400";
                    else if(opt.plausibility.includes("Plausible")) color="#9F6000";
                    else if(opt.plausibility.includes("Less") || opt.plausibility.includes("Not")) color="#8B0000";
                    doc.setTextColor(color);
                    doc.text(`   ${letter}. ${opt.option}`, 12, y); y+=7;

                    if(opt.correct) answerKey.push(`${qNum}: ${letter}`);
                    // Optional rationale
                    // doc.text(`      [${opt.plausibility}] ${opt.rationale}`, 12, y); y+=5;

                    if(y>280){ doc.addPage(); y=10; }
                });
                y+=5;
                qNum++;
            }

            // Answer Key page
            doc.addPage();
            y=10;
            doc.setTextColor("#000000");
            doc.setFontSize(14);
            doc.text(`Answer Key for ${student}`, 10, y); y+=10;
            doc.setFontSize(12);
            answerKey.forEach(a=>{
                doc.text(a, 10, y); y+=7;
                if(y>280){ doc.addPage(); y=10; }
            });

            doc.save(`Quiz_${student}.pdf`);
        }

        resultsDiv.innerHTML = `Generated quizzes for ${studentNames.length} student(s) successfully!`;

    } catch(err){
        resultsDiv.innerHTML = 'Error: ' + err.message;
    }
}
</script>
</body>
</html>
